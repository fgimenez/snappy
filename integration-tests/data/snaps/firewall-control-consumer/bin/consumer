#! /usr/bin/env python3

import subprocess
import sys
from http.server import BaseHTTPRequestHandler, HTTPServer

result_map={'A': 'DNAT       tcp  --  anywhere             172.26.0.15          tcp dpt:tproxy to:127.0.0.1:8081',
            'D': 'target     prot opt source               destination'}
ERROR_MSG = "error controlling firewall"

def fw_control(action):
  subprocess.check_output(
    "iptables -t nat -{} OUTPUT -p tcp -d ".format(action) +
    "172.26.0.15 --dport 8081 -j DNAT --to-destination "+
    "127.0.0.1:8081", shell=True)
  return str(subprocess.check_output(
    "iptables --list OUTPUT -t nat", shell=True))

def get_message(action):
  try:
    result = fw_control(action)
    expected = result_map[action]
    if expected in result:
      message = "ok\n"
    else:
      message = "error controlling firewall\n"
  except Exception as e:
    mm = str(subprocess.check_output("tail -n 10 /var/log/syslog", shell=True))
    message = "Exception: " + \
              repr(e) + mm

  return message

class testRequestHandler(BaseHTTPRequestHandler):
  def do_GET(self):
    self.send_response(200)

    self.send_header('Content-type','text/html')
    self.end_headers()

    if self.path == "/":
      message = "ok\n"
    else:
      action = self.path[1:]
      message = get_message(action)

    self.wfile.write(bytes('<!doctype html>'+message, "utf8"))
    return

def run():
  server_address = ('', 8081)
  httpd = HTTPServer(server_address, testRequestHandler)
  httpd.serve_forever()

if __name__ == '__main__':
  sys.exit(run())
